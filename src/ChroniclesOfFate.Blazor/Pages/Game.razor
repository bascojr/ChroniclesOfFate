@page "/play/{SessionId:int}"
@attribute [Authorize]
@using ChroniclesOfFate.Blazor.Services
@using ChroniclesOfFate.Core.DTOs
@using ChroniclesOfFate.Core.Enums
@inject IGameApiService GameApi
@inject NavigationManager Navigation

<div class="game-play-container">
    @if (isLoading)
    {
        <div class="loading">Loading your adventure...</div>
    }
    else if (gameState == null)
    {
        <div class="error">Failed to load game. <a href="/sessions">Return to sessions</a></div>
    }
    else
    {
        <div class="game-header-bar">
            <div class="character-summary">
                <h2>@gameState.Character.Name</h2>
                <span class="class-badge">@gameState.Character.Class</span>
                <span class="level">Level @gameState.Character.Level</span>
            </div>
            <div class="time-info">
                <span class="season @gameState.SeasonInfo.Season.ToString().ToLower()">@GetSeasonIcon(gameState.SeasonInfo.Season) @gameState.SeasonInfo.Name</span>
                <span class="date">Year @gameState.Character.CurrentYear, Month @gameState.Character.CurrentMonth</span>
                <span class="turn">Turn @gameState.Character.TotalTurns / 120</span>
            </div>
        </div>

        <div class="game-content">
            <div class="stats-panel">
                <h3>Stats</h3>
                <div class="stat-row"><span>STR</span><div class="stat-bar"><div style="width:@(gameState.Character.Strength/5)%;background:#e74c3c"></div></div><span>@gameState.Character.Strength</span></div>
                <div class="stat-row"><span>AGI</span><div class="stat-bar"><div style="width:@(gameState.Character.Agility/5)%;background:#3498db"></div></div><span>@gameState.Character.Agility</span></div>
                <div class="stat-row"><span>INT</span><div class="stat-bar"><div style="width:@(gameState.Character.Intelligence/5)%;background:#9b59b6"></div></div><span>@gameState.Character.Intelligence</span></div>
                <div class="stat-row"><span>END</span><div class="stat-bar"><div style="width:@(gameState.Character.Endurance/5)%;background:#27ae60"></div></div><span>@gameState.Character.Endurance</span></div>
                <div class="stat-row"><span>CHA</span><div class="stat-bar"><div style="width:@(gameState.Character.Charisma/5)%;background:#f39c12"></div></div><span>@gameState.Character.Charisma</span></div>
                <div class="stat-row"><span>LCK</span><div class="stat-bar"><div style="width:@(gameState.Character.Luck/5)%;background:#1abc9c"></div></div><span>@gameState.Character.Luck</span></div>

                <div class="resource-bars">
                    <div class="resource-bar-container">
                        <div class="resource-bar-header">
                            <span class="resource-label">‚ù§Ô∏è Health</span>
                            <span class="resource-value">@gameState.Character.CurrentHealth / @gameState.Character.MaxHealth</span>
                        </div>
                        <div class="resource-bar"><div style="width:@(GetHealthPercent())%;background:linear-gradient(90deg, #c0392b, #e74c3c)"></div></div>
                    </div>
                    <div class="resource-bar-container">
                        <div class="resource-bar-header">
                            <span class="resource-label">‚ö° Energy</span>
                            <span class="resource-value">@gameState.Character.CurrentEnergy / @gameState.Character.MaxEnergy</span>
                        </div>
                        <div class="resource-bar"><div style="width:@(GetEnergyPercent())%;background:linear-gradient(90deg, #f39c12, #f1c40f)"></div></div>
                    </div>
                    <div class="resource-bar-container">
                        <div class="resource-bar-header">
                            <span class="resource-label">‚ú® XP</span>
                            <span class="resource-value">@GetXpDisplayText()</span>
                        </div>
                        <div class="resource-bar"><div style="width:@(GetXpPercent())%;background:linear-gradient(90deg, #8e44ad, #9b59b6)"></div></div>
                    </div>
                </div>
                <div class="resources-secondary">
                    <div class="resource"><span>üí∞ Gold</span><span>@gameState.Character.Gold</span></div>
                    <div class="resource"><span>‚≠ê Rep</span><span>@gameState.Character.Reputation</span></div>
                </div>
                <button class="skills-btn" @onclick="() => showSkills = true">
                    ‚ú® Skills (@characterSkills.Count)
                </button>
                <div class="power">Total Power: <strong>@gameState.Character.TotalPower</strong></div>
            </div>

            <div class="action-panel">
                @if (currentEvent != null)
                {
                    <div class="event-card">
                        <span class="rarity">@currentEvent.Rarity</span>
                        <h3>@currentEvent.Title</h3>
                        <p>@currentEvent.Description</p>
                        <div class="choices">
                            @foreach (var choice in currentEvent.Choices.Where(c => !c.IsHidden))
                            {
                                <button @onclick="() => SelectChoice(choice)" disabled="@isProcessing">
                                    @choice.Text
                                    @if (choice.CheckStat.HasValue)
                                    {
                                        <small>[@choice.CheckStat: @choice.CheckDifficulty]</small>
                                    }
                                </button>
                            }
                        </div>
                    </div>
                }
                else if (battleResult != null)
                {
                    <div class="battle-result @battleResult.Result.ToString().ToLower()">
                        <h3>@(battleResult.Result == BattleResult.Victory ? "‚öîÔ∏è Victory!" : "üíÄ Defeat")</h3>
                        <p class="battle-narrative">@battleResult.Narrative</p>

                        <div class="battle-rewards">
                            @if (battleResult.ExperienceGained > 0) { <span class="reward">+@battleResult.ExperienceGained XP</span> }
                            @if (battleResult.GoldGained > 0) { <span class="reward">+@battleResult.GoldGained Gold</span> }
                            @if (battleResult.ReputationGained > 0) { <span class="reward">+@battleResult.ReputationGained Rep</span> }
                            @if (battleResult.HealthLost > 0) { <span class="damage">-@battleResult.HealthLost HP</span> }
                        </div>

                        <button class="btn-toggle-log" @onclick="() => showCombatLog = !showCombatLog">
                            @(showCombatLog ? "Hide" : "Show") Combat Log (@battleResult.Rounds.Count rounds)
                        </button>

                        @if (showCombatLog)
                        {
                            <div class="combat-log">
                                <div class="combat-log-header">
                                    <span>You vs @battleResult.Enemy.Name (Tier @battleResult.Enemy.DifficultyTier)</span>
                                </div>
                                @foreach (var round in battleResult.Rounds)
                                {
                                    <div class="combat-round">
                                        <div class="round-header">Round @round.RoundNumber</div>
                                        <div class="round-actions">
                                            <div class="action player-action">
                                                <span class="action-label">You:</span>
                                                <span class="action-text">@round.PlayerAction</span>
                                                @if (round.PlayerDamage > 0)
                                                {
                                                    <span class="damage-dealt">@round.PlayerDamage dmg</span>
                                                }
                                            </div>
                                            <div class="action enemy-action">
                                                <span class="action-label">@battleResult.Enemy.Name:</span>
                                                <span class="action-text">@round.EnemyAction</span>
                                                @if (round.EnemyDamage > 0)
                                                {
                                                    <span class="damage-taken">@round.EnemyDamage dmg</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="round-status">
                                            <span class="health player-health">Your HP: @round.PlayerHealthRemaining</span>
                                            <span class="health enemy-health">Enemy HP: @round.EnemyHealthRemaining</span>
                                        </div>
                                        @if (!string.IsNullOrEmpty(round.Narrative))
                                        {
                                            <div class="round-narrative">@round.Narrative</div>
                                        }
                                    </div>
                                }
                            </div>
                        }

                        <button class="btn-continue" @onclick="CloseBattleResult">Continue</button>
                    </div>
                }
                else
                {
                    <div class="actions">
                        <button class="train" @onclick="() => showTraining = true" disabled="@isProcessing">üí™ Train</button>
                        <button class="rest" @onclick="() => ProcessAction(ActionType.Rest)" disabled="@isProcessing">üõèÔ∏è Rest</button>
                        <button class="explore" @onclick="() => ProcessAction(ActionType.Explore)" disabled="@isProcessing">üó∫Ô∏è Explore</button>
                        <button class="battle" @onclick="() => showBattle = true" disabled="@isProcessing">‚öîÔ∏è Battle</button>
                    </div>

                    @if (showTraining)
                    {
                        <div class="sub-options">
                            <h4>Choose Training:</h4>
                            @foreach (var t in trainingScenarios)
                            {
                                <button @onclick="() => ProcessAction(ActionType.Train, t.Id)" disabled="@isProcessing">
                                    @t.Name (@t.PrimaryStat +@t.BaseStatGain) ‚ö°@t.EnergyCost
                                    @if (t.HasSeasonalBonus) { <span>üåü</span> }
                                </button>
                            }
                            <button class="cancel" @onclick="() => showTraining = false">Cancel</button>
                        </div>
                    }

                    @if (showBattle)
                    {
                        <div class="sub-options">
                            <h4>Choose Enemy (‚ö°30):</h4>
                            @foreach (var e in enemies)
                            {
                                <button @onclick="() => ProcessAction(ActionType.Battle, e.Id)" disabled="@isProcessing">
                                    @e.Name (Tier @e.DifficultyTier)
                                </button>
                            }
                            <button @onclick="() => ProcessAction(ActionType.Battle, null)" disabled="@isProcessing">üé≤ Random</button>
                            <button class="cancel" @onclick="() => showBattle = false">Cancel</button>
                        </div>
                    }

                    <div class="message-log">
                        <h4>üìú Adventure Log</h4>
                        @if (!messageLog.Any())
                        {
                            <div class="log-entry action">
                                <span class="log-message">It is @gameState.SeasonInfo.Name. What will you do?</span>
                            </div>
                        }
                        @foreach (var entry in messageLog)
                        {
                            <div class="log-entry @entry.Type">
                                <span class="log-date">Y@(entry.Year) @GetMonthName(entry.Month)</span>
                                <span class="log-message">@entry.Message</span>
                                @if (entry.StatChanges != null && entry.StatChanges.Any())
                                {
                                    <div class="log-stats">
                                        @foreach (var c in entry.StatChanges)
                                        {
                                            <span class="@(c.Change >= 0 ? "pos" : "neg")">@c.StatName: @(c.Change >= 0 ? "+" : "")@c.Change</span>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="storybook-panel">
                <h3>üìö Storybooks</h3>
                @for (int i = 0; i < 5; i++)
                {
                    var book = gameState.EquippedStorybooks.ElementAtOrDefault(i);
                    @if (book != null)
                    {
                        <div class="slot equipped has-tooltip">
                            @book.Name
                            <div class="slot-tooltip">
                                <h4>@book.Name</h4>
                                <p class="tooltip-desc">@book.Description</p>
                                <div class="tooltip-stats">
                                    <strong>Stat Bonuses:</strong>
                                    <div class="tooltip-bonuses">
                                        @if (book.StrengthBonus > 0) { <span>+@book.StrengthBonus STR</span> }
                                        @if (book.AgilityBonus > 0) { <span>+@book.AgilityBonus AGI</span> }
                                        @if (book.IntelligenceBonus > 0) { <span>+@book.IntelligenceBonus INT</span> }
                                        @if (book.EnduranceBonus > 0) { <span>+@book.EnduranceBonus END</span> }
                                        @if (book.CharismaBonus > 0) { <span>+@book.CharismaBonus CHA</span> }
                                        @if (book.LuckBonus > 0) { <span>+@book.LuckBonus LCK</span> }
                                    </div>
                                </div>
                                <div class="tooltip-events">
                                    <strong>Events (@book.Events.Count):</strong>
                                    <ul>
                                        @foreach (var evt in book.Events)
                                        {
                                            <li class="@evt.Rarity.ToString().ToLower()">
                                                <span class="event-rarity">[@evt.Rarity]</span> @evt.Title
                                            </li>
                                        }
                                    </ul>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="slot empty">Slot @(i + 1)</div>
                    }
                }
                <h4>Season: @gameState.SeasonInfo.Name</h4>
                @foreach (var b in gameState.SeasonInfo.Bonuses)
                {
                    <div class="bonus">@b</div>
                }
            </div>
        </div>

        @if (gameState.Character.IsGameComplete)
        {
            <div class="complete-overlay">
                <div class="complete-content">
                    <h2>üèÜ Journey Complete!</h2>
                    <p>Power: @gameState.Character.TotalPower | Level: @gameState.Character.Level | Gold: @gameState.Character.Gold</p>
                    <button @onclick='() => Navigation.NavigateTo("/sessions")'>Return to Menu</button>
                </div>
            </div>
        }

        @if (showSkills)
        {
            <div class="modal-overlay" @onclick="() => showSkills = false">
                <div class="modal-content skills-modal" @onclick:stopPropagation="true">
                    <h2>‚ú® Skills</h2>
                    @if (!characterSkills.Any())
                    {
                        <p class="no-skills">You haven't learned any skills yet. Explore the world and make choices during events to acquire skills!</p>
                    }
                    else
                    {
                        @if (characterSkills.Any(s => s.Skill.SkillType == SkillType.Passive))
                        {
                            <div class="skill-category">
                                <h3>üõ°Ô∏è Passive Skills</h3>
                                <p class="category-desc">Automatically active during combat</p>
                                <div class="skills-grid">
                                    @foreach (var cs in characterSkills.Where(s => s.Skill.SkillType == SkillType.Passive))
                                    {
                                        <div class="skill-card @cs.Skill.Rarity.ToString().ToLower()">
                                            <div class="skill-header">
                                                <span class="skill-name">@cs.Skill.Name</span>
                                                <span class="skill-rarity">@cs.Skill.Rarity</span>
                                            </div>
                                            <p class="skill-desc">@cs.Skill.Description</p>
                                            <div class="skill-effect">
                                                @GetPassiveEffectText(cs.Skill)
                                            </div>
                                            <div class="skill-source">From: @cs.AcquisitionSource</div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (characterSkills.Any(s => s.Skill.SkillType == SkillType.Active))
                        {
                            <div class="skill-category">
                                <h3>‚öîÔ∏è Active Skills</h3>
                                <p class="category-desc">Triggered during combat based on chance</p>
                                <div class="skills-grid">
                                    @foreach (var cs in characterSkills.Where(s => s.Skill.SkillType == SkillType.Active))
                                    {
                                        <div class="skill-card @cs.Skill.Rarity.ToString().ToLower()">
                                            <div class="skill-header">
                                                <span class="skill-name">@cs.Skill.Name</span>
                                                <span class="skill-rarity">@cs.Skill.Rarity</span>
                                            </div>
                                            <p class="skill-desc">@cs.Skill.Description</p>
                                            <div class="skill-effect">
                                                @GetActiveEffectText(cs.Skill)
                                            </div>
                                            <div class="skill-source">From: @cs.AcquisitionSource</div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (characterSkills.Any(s => s.Skill.SkillType == SkillType.Bonus))
                        {
                            <div class="skill-category">
                                <h3>üåü Bonus Skills</h3>
                                <p class="category-desc">Adventure-wide passive bonuses</p>
                                <div class="skills-grid">
                                    @foreach (var cs in characterSkills.Where(s => s.Skill.SkillType == SkillType.Bonus))
                                    {
                                        <div class="skill-card @cs.Skill.Rarity.ToString().ToLower()">
                                            <div class="skill-header">
                                                <span class="skill-name">@cs.Skill.Name</span>
                                                <span class="skill-rarity">@cs.Skill.Rarity</span>
                                            </div>
                                            <p class="skill-desc">@cs.Skill.Description</p>
                                            <div class="skill-effect">
                                                @GetBonusEffectText(cs.Skill)
                                            </div>
                                            <div class="skill-source">From: @cs.AcquisitionSource</div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                    <div class="modal-actions">
                        <button class="btn-secondary" @onclick="() => showSkills = false">Close</button>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter] public int SessionId { get; set; }
    private GameStateDto? gameState;
    private bool isLoading = true;
    private bool isProcessing = false;
    private string lastNarrative = "";
    private List<StatChangeDto> lastStatChanges = new();
    private RandomEventDto? currentEvent;
    private BattleResultDto? battleResult;
    private bool showTraining, showBattle, showCombatLog;
    private bool showSkills = false;
    private List<TrainingScenarioDto> trainingScenarios = new();
    private List<EnemyDto> enemies = new();
    private List<MessageLogEntryDto> messageLog = new();
    private List<CharacterSkillDto> characterSkills = new();
    private const int MaxLogEntries = 20;

    protected override async Task OnInitializedAsync()
    {
        await LoadGameState();
        await LoadMessageLog();
        await LoadSkills();
    }

    private async Task LoadSkills()
    {
        characterSkills = await GameApi.GetSkillsAsync(SessionId);
    }

    private async Task LoadMessageLog()
    {
        messageLog = await GameApi.GetMessageLogAsync(SessionId);
    }

    private async Task LoadGameState()
    {
        isLoading = true;
        gameState = await GameApi.GetGameStateAsync(SessionId);
        trainingScenarios = await GameApi.GetTrainingScenariosAsync(SessionId);
        enemies = await GameApi.GetEnemiesAsync(SessionId);
        isLoading = false;
    }

    private void CloseBattleResult()
    {
        battleResult = null;
        showCombatLog = false;
    }

    private async Task ProcessAction(ActionType action, int? targetId = null)
    {
        isProcessing = true;
        showTraining = showBattle = showCombatLog = false;
        var result = await GameApi.ProcessTurnAsync(SessionId, action, targetId);
        if (result != null)
        {
            // Parse narrative and mini events (mini events contain markers like (+X or (-X)
            var (mainNarrative, miniEventNarrative) = ParseNarrativeAndMiniEvent(result.Narrative);
            var (mainChanges, miniEventChanges) = SplitStatChanges(result.StatChanges, miniEventNarrative);

            lastNarrative = mainNarrative;
            lastStatChanges = mainChanges;
            currentEvent = result.TriggeredEvent;
            battleResult = result.BattleResult;

            // Get current game date before it advances
            int year = result.UpdatedCharacter?.CurrentYear ?? gameState?.Character.CurrentYear ?? 1;
            int month = result.UpdatedCharacter?.CurrentMonth ?? gameState?.Character.CurrentMonth ?? 1;

            // Add main action to log
            await AddToMessageLogAsync(mainNarrative, mainChanges, "action", year, month);

            // Add mini event to log if present
            if (!string.IsNullOrEmpty(miniEventNarrative))
            {
                await AddToMessageLogAsync(miniEventNarrative, miniEventChanges, miniEventNarrative.Contains("(-") ? "negative" : "positive", year, month);
            }

            // Log battle result
            if (result.BattleResult != null)
            {
                var br = result.BattleResult;
                var battleLogType = br.Result == BattleResult.Victory ? "positive" : "negative";
                var battleIcon = br.Result == BattleResult.Victory ? "‚öîÔ∏è" : "üíÄ";
                var battleOutcome = br.Result == BattleResult.Victory ? "Victory" : "Defeat";
                var battleStats = new List<StatChangeDto>();
                if (br.ExperienceGained > 0) battleStats.Add(new StatChangeDto("Experience", 0, br.ExperienceGained, br.ExperienceGained));
                if (br.GoldGained > 0) battleStats.Add(new StatChangeDto("Gold", 0, br.GoldGained, br.GoldGained));
                if (br.ReputationGained > 0) battleStats.Add(new StatChangeDto("Reputation", 0, br.ReputationGained, br.ReputationGained));
                if (br.HealthLost > 0) battleStats.Add(new StatChangeDto("Health", 0, -br.HealthLost, -br.HealthLost));

                var battleLog = $"{battleIcon} {battleOutcome} vs {br.Enemy.Name} ({br.Rounds.Count} rounds)";
                await AddToMessageLogAsync(battleLog, battleStats, battleLogType, year, month);
            }

            await LoadGameState();
        }
        isProcessing = false;
    }

    private (string mainNarrative, string miniEventNarrative) ParseNarrativeAndMiniEvent(string fullNarrative)
    {
        // Mini events contain stat change markers like (+X or (-X
        // Look for patterns that indicate a mini event started
        var miniEventPatterns = new[] { "A surge of", "Your reflexes", "A moment of clarity", "You feel more",
            "Your confidence", "A fortunate", "You find a forgotten", "A grateful stranger", "You discover a small",
            "A merchant overpays", "A refreshing breeze", "You find a moment", "A kind soul", "The beauty of nature",
            "Word of your deeds", "A local bard", "Your good nature", "People whisper", "You reflect on",
            "A wise traveler", "You observe something", "Experience from your",
            "A bout of weakness", "A stumble makes", "Mental fog", "Fatigue wears", "An awkward encounter",
            "An ill omen", "A pickpocket", "You lose some coins", "An unexpected toll", "A scam artist",
            "The heat of the day", "Restless thoughts", "A sudden chill", "An uneasy feeling",
            "You stub your toe", "A minor fall", "Something you ate", "A small creature" };

        foreach (var pattern in miniEventPatterns)
        {
            int idx = fullNarrative.IndexOf(pattern, StringComparison.OrdinalIgnoreCase);
            if (idx > 0)
            {
                return (fullNarrative.Substring(0, idx).Trim(), fullNarrative.Substring(idx).Trim());
            }
        }

        return (fullNarrative, "");
    }

    private (List<StatChangeDto> mainChanges, List<StatChangeDto> miniEventChanges) SplitStatChanges(List<StatChangeDto> allChanges, string miniEventNarrative)
    {
        if (string.IsNullOrEmpty(miniEventNarrative))
            return (allChanges, new List<StatChangeDto>());

        var mainChanges = new List<StatChangeDto>();
        var miniChanges = new List<StatChangeDto>();

        // Mini events typically affect: a single random stat, Gold, Energy, Health, Reputation, or Experience
        // The mini event narrative mentions the affected stat
        foreach (var change in allChanges)
        {
            bool isMiniEventChange = miniEventNarrative.Contains(change.StatName, StringComparison.OrdinalIgnoreCase) ||
                                      (miniEventNarrative.Contains("Gold") && change.StatName == "Gold") ||
                                      (miniEventNarrative.Contains("Energy") && change.StatName == "Energy") ||
                                      (miniEventNarrative.Contains("Health") && change.StatName == "Health") ||
                                      (miniEventNarrative.Contains("Reputation") && change.StatName == "Reputation") ||
                                      (miniEventNarrative.Contains("Experience") && change.StatName == "Experience");

            // If the narrative mentions a stat by name (e.g., "+3 Strength"), it's a mini event change
            if (isMiniEventChange && miniEventNarrative.Contains($"{Math.Abs(change.Change)} {change.StatName}"))
            {
                miniChanges.Add(change);
            }
            else
            {
                mainChanges.Add(change);
            }
        }

        // If we couldn't split properly, just return all as main
        if (miniChanges.Count == 0 && !string.IsNullOrEmpty(miniEventNarrative))
        {
            // Try to find the last change that matches the mini event type
            var lastChange = allChanges.LastOrDefault();
            if (lastChange != null && miniEventNarrative.Contains(lastChange.StatName, StringComparison.OrdinalIgnoreCase))
            {
                miniChanges.Add(lastChange);
                mainChanges = allChanges.Take(allChanges.Count - 1).ToList();
            }
            else
            {
                mainChanges = allChanges;
            }
        }

        return (mainChanges, miniChanges);
    }

    private async Task AddToMessageLogAsync(string message, List<StatChangeDto> statChanges, string type, int year, int month)
    {
        var dto = new AddMessageLogDto(message, type, year, month, statChanges);
        var result = await GameApi.AddMessageLogAsync(SessionId, dto);
        if (result != null)
        {
            messageLog.Insert(0, result);
            if (messageLog.Count > MaxLogEntries)
                messageLog.RemoveAt(messageLog.Count - 1);
        }
    }

    private string GetMonthName(int month) => month switch
    {
        1 => "Jan", 2 => "Feb", 3 => "Mar", 4 => "Apr", 5 => "May", 6 => "Jun",
        7 => "Jul", 8 => "Aug", 9 => "Sep", 10 => "Oct", 11 => "Nov", 12 => "Dec",
        _ => $"M{month}"
    };

    private async Task SelectChoice(EventChoiceDto choice)
    {
        if (currentEvent == null) return;
        isProcessing = true;

        // Store event info before processing
        var eventTitle = currentEvent.Title;
        var sourceStorybook = currentEvent.SourceStorybook;
        var eventRarity = currentEvent.Rarity;

        var result = await GameApi.ProcessEventChoiceAsync(SessionId, currentEvent.Id, choice.Id);
        if (result != null)
        {
            lastNarrative = result.ResultDescription;
            lastStatChanges = result.StatChanges;
            currentEvent = result.FollowUpEvent;
            await LoadGameState();
            await LoadSkills(); // Reload skills in case event granted a skill

            // Log the storybook event to message log
            int year = gameState?.Character.CurrentYear ?? 1;
            int month = gameState?.Character.CurrentMonth ?? 1;

            string logMessage;
            if (!string.IsNullOrEmpty(sourceStorybook))
            {
                logMessage = $"üìñ [{sourceStorybook}] {eventTitle}: {result.ResultDescription}";
            }
            else
            {
                logMessage = $"‚ö° {eventTitle}: {result.ResultDescription}";
            }

            // Determine log type based on outcome
            string logType = result.CheckSucceeded == false ? "negative" : "positive";

            await AddToMessageLogAsync(logMessage, result.StatChanges, logType, year, month);
        }
        isProcessing = false;
    }

    private string GetSeasonIcon(Season s) => s switch { Season.Spring => "üå∏", Season.Summer => "‚òÄÔ∏è", Season.Autumn => "üçÇ", Season.Winter => "‚ùÑÔ∏è", _ => "üåç" };

    private int GetHealthPercent()
    {
        if (gameState?.Character == null || gameState.Character.MaxHealth == 0) return 0;
        return (int)((double)gameState.Character.CurrentHealth / gameState.Character.MaxHealth * 100);
    }

    private int GetEnergyPercent()
    {
        if (gameState?.Character == null || gameState.Character.MaxEnergy == 0) return 0;
        return (int)((double)gameState.Character.CurrentEnergy / gameState.Character.MaxEnergy * 100);
    }

    private int GetXpPercent()
    {
        if (gameState?.Character == null) return 0;
        if (gameState.Character.IsMaxLevel) return 100;

        int currentLevel = gameState.Character.Level;
        // Level 1 starts at 0 XP, higher levels start at their threshold
        int currentLevelXp = currentLevel == 1 ? 0 : currentLevel * currentLevel * 50;
        int nextLevelXp = gameState.Character.ExperienceForNextLevel;
        int currentXp = gameState.Character.Experience;

        if (nextLevelXp <= currentLevelXp) return 100;

        int xpIntoLevel = currentXp - currentLevelXp;
        int xpNeededForLevel = nextLevelXp - currentLevelXp;

        return Math.Clamp((int)((double)xpIntoLevel / xpNeededForLevel * 100), 0, 100);
    }

    private string GetXpDisplayText()
    {
        if (gameState?.Character == null) return "0";
        if (gameState.Character.IsMaxLevel) return "MAX LEVEL";

        int currentLevel = gameState.Character.Level;
        // Level 1 starts at 0 XP, higher levels start at their threshold
        int currentLevelXp = currentLevel == 1 ? 0 : currentLevel * currentLevel * 50;
        int nextLevelXp = gameState.Character.ExperienceForNextLevel;
        int currentXp = gameState.Character.Experience;

        int xpIntoLevel = currentXp - currentLevelXp;
        int xpNeededForLevel = nextLevelXp - currentLevelXp;

        return $"{xpIntoLevel} / {xpNeededForLevel}";
    }

    private string GetPassiveEffectText(SkillDto skill)
    {
        if (!skill.PassiveEffect.HasValue) return "";
        return skill.PassiveEffect.Value switch
        {
            PassiveEffect.Evasion => $"Evasion: {skill.PassiveValue:P0}",
            PassiveEffect.CriticalChance => $"Critical Chance: +{skill.PassiveValue:P0}",
            PassiveEffect.DamageReduction => $"Damage Reduction: {skill.PassiveValue:P0}",
            PassiveEffect.LifeSteal => $"Life Steal: {skill.PassiveValue:P0}",
            PassiveEffect.CounterAttack => $"Counter Attack: {skill.PassiveValue:P0}",
            PassiveEffect.Thorns => $"Thorns: {skill.PassiveValue:P0} damage reflected",
            _ => ""
        };
    }

    private string GetActiveEffectText(SkillDto skill)
    {
        var parts = new List<string>();
        if (skill.TriggerChance > 0) parts.Add($"Trigger: {skill.TriggerChance:P0}");
        if (skill.BaseDamage > 0) parts.Add($"Base Damage: {skill.BaseDamage}");
        if (skill.ScalingStat.HasValue && skill.ScalingMultiplier > 0)
            parts.Add($"Scales: {skill.ScalingMultiplier:P0} {skill.ScalingStat}");
        return string.Join(" | ", parts);
    }

    private string GetBonusEffectText(SkillDto skill)
    {
        if (!skill.BonusEffect.HasValue) return "";
        var effectName = skill.BonusEffect.Value switch
        {
            BonusEffect.GoldGain => "Gold Gain",
            BonusEffect.ExperienceGain => "XP Gain",
            BonusEffect.EnergyGain => "Energy Gain",
            BonusEffect.HealthRegen => "Health Regen",
            BonusEffect.LuckBoost => "Luck Boost",
            BonusEffect.TrainingBoost => "Training Boost",
            _ => "Bonus"
        };

        if (skill.BonusPercentage > 0)
            return $"{effectName}: +{skill.BonusPercentage:P0}";
        if (skill.BonusFlatValue > 0)
            return $"{effectName}: +{skill.BonusFlatValue}";
        return effectName;
    }
}
