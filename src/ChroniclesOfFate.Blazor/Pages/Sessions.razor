@page "/sessions"
@attribute [Authorize]
@using ChroniclesOfFate.Blazor.Services
@using ChroniclesOfFate.Core.DTOs
@using ChroniclesOfFate.Core.Enums
@inject IGameApiService GameApi
@inject NavigationManager Navigation

<div class="sessions-container">
    <h2>Your Adventures</h2>

    @if (isLoading)
    {
        <div class="loading">Loading your saved games...</div>
    }
    else
    {
        <div class="sessions-grid">
            @foreach (var session in sessions)
            {
                <div class="session-card" @onclick="() => LoadGame(session.Id)">
                    <h3>@session.SessionName</h3>
                    <p class="character-info">@session.CharacterName â€¢ Level @session.CharacterLevel</p>
                    <p class="progress">Turn @session.TotalTurns / 120</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: @((session.TotalTurns ?? 0) / 1.2)%"></div>
                    </div>
                    <p class="state @session.State.ToString().ToLower()">@session.State</p>
                </div>
            }

            <div class="session-card new-game" @onclick="ShowNewGameDialog">
                <div class="new-game-icon">+</div>
                <h3>New Adventure</h3>
                <p>Start a new 10-year journey</p>
            </div>
        </div>
    }
</div>

@if (showNewGameDialog)
{
    <div class="modal-overlay" @onclick="HideNewGameDialog">
        <div class="modal-content storybook-modal" @onclick:stopPropagation>
            <h2>Begin New Adventure</h2>

            @if (creationStep == 1)
            {
                <div class="form-group">
                    <label>Save Name</label>
                    <input type="text" @bind="newGameName" placeholder="My Adventure" class="form-input" />
                </div>

                <div class="form-group">
                    <label>Character Name</label>
                    <input type="text" @bind="characterName" placeholder="Enter name" class="form-input" />
                </div>

                <div class="form-group">
                    <label>Choose Your Class</label>
                    <div class="class-grid">
                        @foreach (CharacterClass cls in Enum.GetValues<CharacterClass>())
                        {
                            <div class="class-card @(selectedClass == cls ? "selected" : "")" @onclick="() => selectedClass = cls">
                                <div class="class-icon">@GetClassIcon(cls)</div>
                                <h4>@cls</h4>
                                <p>@GetClassDescription(cls)</p>
                            </div>
                        }
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-secondary" @onclick="HideNewGameDialog">Cancel</button>
                    <button class="btn-primary" @onclick="GoToStorybookSelection" disabled="@(string.IsNullOrWhiteSpace(characterName))">
                        Next: Choose Storybooks
                    </button>
                </div>
            }
            else if (creationStep == 2)
            {
                <p class="step-info">Select up to 5 storybooks to embed in your adventure. They provide stat bonuses and unlock special events!</p>

                <div class="selected-count">Selected: @selectedStorybookIds.Count / 5</div>

                @if (isLoadingStorybooks)
                {
                    <div class="loading">Loading storybooks...</div>
                }
                else
                {
                    <div class="storybook-selection-container">
                        <div class="storybook-grid">
                            @foreach (var book in availableStorybooks)
                            {
                                bool isSelected = selectedStorybookIds.Contains(book.Id);
                                <div class="storybook-card @(isSelected ? "selected" : "") @(hoveredStorybook?.Id == book.Id ? "hovered" : "")"
                                     @onclick="() => ToggleStorybook(book.Id)"
                                     @onmouseenter="() => hoveredStorybook = book"
                                     @onmouseleave="() => hoveredStorybook = null">
                                    <div class="storybook-header">
                                        <span class="storybook-name">@book.Name</span>
                                        <span class="theme-badge">@book.Theme</span>
                                    </div>
                                    <p class="storybook-desc">@book.Description</p>
                                    <div class="storybook-bonuses">
                                        @if (book.StrengthBonus > 0) { <span class="bonus">+@book.StrengthBonus STR</span> }
                                        @if (book.AgilityBonus > 0) { <span class="bonus">+@book.AgilityBonus AGI</span> }
                                        @if (book.IntelligenceBonus > 0) { <span class="bonus">+@book.IntelligenceBonus INT</span> }
                                        @if (book.EnduranceBonus > 0) { <span class="bonus">+@book.EnduranceBonus END</span> }
                                        @if (book.CharismaBonus > 0) { <span class="bonus">+@book.CharismaBonus CHA</span> }
                                        @if (book.LuckBonus > 0) { <span class="bonus">+@book.LuckBonus LCK</span> }
                                    </div>
                                    <div class="storybook-event">ðŸ“– @book.Events.Count events</div>
                                </div>
                            }
                        </div>

                        @if (hoveredStorybook != null)
                        {
                            <div class="storybook-detail-panel">
                                <h4>@hoveredStorybook.Name</h4>
                                <p class="tooltip-desc">@hoveredStorybook.Description</p>
                                <div class="tooltip-stats">
                                    <strong>Stat Bonuses:</strong>
                                    <div class="tooltip-bonuses">
                                        @if (hoveredStorybook.StrengthBonus > 0) { <span>+@hoveredStorybook.StrengthBonus STR</span> }
                                        @if (hoveredStorybook.AgilityBonus > 0) { <span>+@hoveredStorybook.AgilityBonus AGI</span> }
                                        @if (hoveredStorybook.IntelligenceBonus > 0) { <span>+@hoveredStorybook.IntelligenceBonus INT</span> }
                                        @if (hoveredStorybook.EnduranceBonus > 0) { <span>+@hoveredStorybook.EnduranceBonus END</span> }
                                        @if (hoveredStorybook.CharismaBonus > 0) { <span>+@hoveredStorybook.CharismaBonus CHA</span> }
                                        @if (hoveredStorybook.LuckBonus > 0) { <span>+@hoveredStorybook.LuckBonus LCK</span> }
                                    </div>
                                </div>
                                <div class="tooltip-events">
                                    <strong>Events (@hoveredStorybook.Events.Count):</strong>
                                    <ul>
                                        @foreach (var evt in hoveredStorybook.Events)
                                        {
                                            <li class="@evt.Rarity.ToString().ToLower()">
                                                <span class="event-rarity">[@evt.Rarity]</span> @evt.Title
                                            </li>
                                        }
                                    </ul>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="storybook-detail-panel empty">
                                <p>Hover over a storybook to see details</p>
                            </div>
                        }
                    </div>
                }

                <div class="modal-actions">
                    <button class="btn-secondary" @onclick="() => creationStep = 1">Back</button>
                    <button class="btn-primary" @onclick="CreateGame" disabled="@isCreating">
                        @(isCreating ? "Creating..." : "Start Adventure")
                    </button>
                </div>
            }
        </div>
    </div>
}

@code {
    private List<GameSessionListDto> sessions = new();
    private bool isLoading = true;
    private bool showNewGameDialog = false;
    private bool isCreating = false;
    private int creationStep = 1;

    private string newGameName = "";
    private string characterName = "";
    private CharacterClass selectedClass = CharacterClass.Warrior;

    private List<StorybookDto> availableStorybooks = new();
    private List<int> selectedStorybookIds = new();
    private bool isLoadingStorybooks = false;
    private StorybookDto? hoveredStorybook = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadSessions();
    }

    private async Task LoadSessions()
    {
        isLoading = true;
        sessions = await GameApi.GetSessionsAsync();
        isLoading = false;
    }

    private void LoadGame(int sessionId)
    {
        Navigation.NavigateTo($"/play/{sessionId}");
    }

    private void ShowNewGameDialog()
    {
        showNewGameDialog = true;
        creationStep = 1;
        newGameName = $"Adventure {DateTime.Now:MMM dd}";
        characterName = "";
        selectedStorybookIds.Clear();
    }

    private void HideNewGameDialog()
    {
        showNewGameDialog = false;
        creationStep = 1;
    }

    private async Task GoToStorybookSelection()
    {
        if (string.IsNullOrWhiteSpace(characterName)) return;

        isLoadingStorybooks = true;
        creationStep = 2;
        availableStorybooks = await GameApi.GetStorybooksAsync();
        isLoadingStorybooks = false;
    }

    private void ToggleStorybook(int storybookId)
    {
        if (selectedStorybookIds.Contains(storybookId))
        {
            selectedStorybookIds.Remove(storybookId);
        }
        else if (selectedStorybookIds.Count < 5)
        {
            selectedStorybookIds.Add(storybookId);
        }
    }

    private async Task CreateGame()
    {
        if (string.IsNullOrWhiteSpace(characterName)) return;

        isCreating = true;
        var session = await GameApi.CreateSessionAsync(
            newGameName,
            characterName,
            selectedClass,
            selectedStorybookIds.Any() ? selectedStorybookIds : null
        );
        isCreating = false;

        if (session != null)
        {
            Navigation.NavigateTo($"/play/{session.Id}");
        }
    }

    private string GetClassIcon(CharacterClass cls) => cls switch
    {
        CharacterClass.Warrior => "âš”ï¸",
        CharacterClass.Mage => "ðŸ”®",
        CharacterClass.Rogue => "ðŸ—¡ï¸",
        CharacterClass.Cleric => "âœ¨",
        CharacterClass.Ranger => "ðŸ¹",
        _ => "ðŸ‘¤"
    };

    private string GetClassDescription(CharacterClass cls) => cls switch
    {
        CharacterClass.Warrior => "High Strength & Endurance",
        CharacterClass.Mage => "High Intelligence & Charisma",
        CharacterClass.Rogue => "High Agility & Luck",
        CharacterClass.Cleric => "Balanced Int & Endurance",
        CharacterClass.Ranger => "High Agility & Strength",
        _ => ""
    };
}
