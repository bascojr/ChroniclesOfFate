@page "/admin/storybooks"
@layout ChroniclesOfFate.Blazor.Shared.AdminLayout
@attribute [Authorize(Roles = "Admin")]
@inject IAdminApiService AdminApi
@using ChroniclesOfFate.Core.Enums

<PageTitle>Storybooks - Admin</PageTitle>

<div class="admin-table-container">
    <div class="admin-table-header">
        <h2>Storybooks</h2>
        <button class="btn-create" @onclick="ShowCreateModal">+ New Storybook</button>
    </div>

    @if (isLoading)
    {
        <div class="admin-loading">Loading storybooks...</div>
    }
    else
    {
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Theme</th>
                    <th>Stat Bonuses</th>
                    <th>Events</th>
                    <th>Unlockable</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var book in storybooks)
                {
                    <tr>
                        <td>@book.Name</td>
                        <td>@book.Theme</td>
                        <td style="font-size: 0.75rem;">
                            @if (book.StrengthBonus != 0) { <span>STR+@book.StrengthBonus </span> }
                            @if (book.AgilityBonus != 0) { <span>AGI+@book.AgilityBonus </span> }
                            @if (book.IntelligenceBonus != 0) { <span>INT+@book.IntelligenceBonus </span> }
                            @if (book.EnduranceBonus != 0) { <span>END+@book.EnduranceBonus </span> }
                            @if (book.CharismaBonus != 0) { <span>CHA+@book.CharismaBonus </span> }
                            @if (book.LuckBonus != 0) { <span>LCK+@book.LuckBonus</span> }
                        </td>
                        <td>@book.EventCount</td>
                        <td>@(book.IsUnlockable ? "Yes" : "No")</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn-view" @onclick="() => ShowEventsModal(book)">Events</button>
                                <button class="btn-edit" @onclick="() => ShowEditModal(book)">Edit</button>
                                <button class="btn-delete" @onclick="() => ShowDeleteConfirm(book)">Delete</button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@* Storybook Edit Modal *@
@if (showModal)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content admin-modal" @onclick:stopPropagation>
            <h2>@(editingStorybook == null ? "Create Storybook" : "Edit Storybook")</h2>

            <div class="form-row">
                <div class="form-group">
                    <label>Name</label>
                    <input class="form-input" @bind="formName" placeholder="Storybook name" />
                </div>
                <div class="form-group">
                    <label>Theme</label>
                    <input class="form-input" @bind="formTheme" placeholder="Combat, Magic, etc." />
                </div>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea @bind="formDescription" placeholder="Describe the storybook..."></textarea>
            </div>

            <div class="form-group">
                <label>Icon URL</label>
                <input class="form-input" @bind="formIconUrl" placeholder="https://..." />
            </div>

            <h4 style="margin: 1rem 0 0.5rem;">Stat Bonuses</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>Strength</label>
                    <input class="form-input" type="number" @bind="formStrengthBonus" />
                </div>
                <div class="form-group">
                    <label>Agility</label>
                    <input class="form-input" type="number" @bind="formAgilityBonus" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Intelligence</label>
                    <input class="form-input" type="number" @bind="formIntelligenceBonus" />
                </div>
                <div class="form-group">
                    <label>Endurance</label>
                    <input class="form-input" type="number" @bind="formEnduranceBonus" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Charisma</label>
                    <input class="form-input" type="number" @bind="formCharismaBonus" />
                </div>
                <div class="form-group">
                    <label>Luck</label>
                    <input class="form-input" type="number" @bind="formLuckBonus" />
                </div>
            </div>

            <div class="form-group">
                <label>Event Trigger Chance (0.0-1.0)</label>
                <input class="form-input" type="number" step="0.01" @bind="formEventTriggerChance" />
            </div>

            <div class="form-row">
                <div class="form-group form-checkbox">
                    <input type="checkbox" @bind="formIsUnlockable" id="isUnlockable" />
                    <label for="isUnlockable">Unlockable</label>
                </div>
            </div>

            <div class="form-group">
                <label>Unlock Condition</label>
                <input class="form-input" @bind="formUnlockCondition" placeholder="Reach level 10, etc." />
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">@errorMessage</div>
            }

            <div class="modal-actions">
                <button class="btn-secondary" @onclick="CloseModal">Cancel</button>
                <button class="btn-primary" @onclick="SaveStorybook" disabled="@isSaving">
                    @(isSaving ? "Saving..." : "Save")
                </button>
            </div>
        </div>
    </div>
}

@* Storybook Events Modal *@
@if (showEventsModal)
{
    <div class="modal-overlay" @onclick="CloseEventsModal">
        <div class="modal-content admin-modal" style="max-width: 1000px;" @onclick:stopPropagation>
            <h2>Events: @selectedStorybook?.Name</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Manage random events for this storybook</p>

            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                <button class="btn-create" @onclick="ShowCreateEventModal">+ New Event</button>
            </div>

            @if (isLoadingEvents)
            {
                <div class="admin-loading">Loading events...</div>
            }
            else if (storybookEvents.Any())
            {
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Rarity</th>
                            <th>Outcome</th>
                            <th>Choices</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var evt in storybookEvents)
                        {
                            <tr>
                                <td>@evt.Title</td>
                                <td>
                                    <span class="badge badge-@evt.Rarity.ToString().ToLower()">@evt.Rarity</span>
                                </td>
                                <td>@evt.OutcomeType</td>
                                <td>@evt.ChoiceCount</td>
                                <td>
                                    <span class="badge @(evt.IsActive ? "badge-active" : "badge-inactive")">
                                        @(evt.IsActive ? "Active" : "Inactive")
                                    </span>
                                </td>
                                <td>
                                    <div class="table-actions">
                                        <button class="btn-view" @onclick="() => ShowChoicesModal(evt)">Choices</button>
                                        <button class="btn-edit" @onclick="() => ShowEditEventModal(evt)">Edit</button>
                                        <button class="btn-delete" @onclick="() => ShowDeleteEventConfirm(evt)">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                    No events defined for this storybook.
                </p>
            }

            <div class="modal-actions">
                <button class="btn-secondary" @onclick="CloseEventsModal">Close</button>
            </div>
        </div>
    </div>
}

@* Event Edit Modal *@
@if (showEventModal)
{
    <div class="modal-overlay" @onclick="CloseEventModal">
        <div class="modal-content admin-modal" @onclick:stopPropagation>
            <h2>@(editingEvent == null ? "Create Event" : "Edit Event")</h2>

            <div class="form-group">
                <label>Title</label>
                <input class="form-input" @bind="eventFormTitle" placeholder="Event title" />
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea @bind="eventFormDescription" placeholder="Event description..."></textarea>
            </div>

            <div class="form-group">
                <label>Image URL</label>
                <input class="form-input" @bind="eventFormImageUrl" placeholder="https://..." />
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Rarity</label>
                    <select @bind="eventFormRarity">
                        @foreach (var rarity in Enum.GetValues<Rarity>())
                        {
                            <option value="@rarity">@rarity</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Outcome Type</label>
                    <select @bind="eventFormOutcomeType">
                        @foreach (var outcome in Enum.GetValues<EventOutcome>())
                        {
                            <option value="@outcome">@outcome</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Trigger Actions (comma-separated)</label>
                    <input class="form-input" @bind="eventFormTriggerActions" placeholder="Train,Explore,Battle" />
                </div>
                <div class="form-group">
                    <label>Base Probability (0.0-1.0)</label>
                    <input class="form-input" type="number" step="0.01" @bind="eventFormBaseProbability" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Trigger Seasons (Optional)</label>
                    <input class="form-input" @bind="eventFormTriggerSeasons" placeholder="Spring,Summer" />
                </div>
                <div class="form-group">
                    <label>Stat Requirements (JSON)</label>
                    <input class="form-input" @bind="eventFormStatRequirements" placeholder='{"Strength": 30}' />
                </div>
            </div>

            <div class="form-group form-checkbox">
                <input type="checkbox" @bind="eventFormIsActive" id="eventIsActive" />
                <label for="eventIsActive">Active</label>
            </div>

            @if (!string.IsNullOrEmpty(eventErrorMessage))
            {
                <div class="error-message">@eventErrorMessage</div>
            }

            <div class="modal-actions">
                <button class="btn-secondary" @onclick="CloseEventModal">Cancel</button>
                <button class="btn-primary" @onclick="SaveEvent" disabled="@isSavingEvent">
                    @(isSavingEvent ? "Saving..." : "Save")
                </button>
            </div>
        </div>
    </div>
}

@* Choices Management Modal *@
@if (showChoicesModal)
{
    <div class="modal-overlay" @onclick="CloseChoicesModal">
        <div class="modal-content admin-modal" style="max-width: 900px;" @onclick:stopPropagation>
            <h2>Manage Choices: @selectedEvent?.Title</h2>

            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                <button class="btn-create" @onclick="ShowAddChoiceModal">+ Add Choice</button>
            </div>

            @if (selectedEvent?.Choices?.Any() == true)
            {
                @foreach (var choice in selectedEvent.Choices.OrderBy(c => c.DisplayOrder))
                {
                    <div class="choice-item">
                        <span class="choice-order">#@choice.DisplayOrder</span>
                        <span class="choice-text">@choice.Text</span>
                        <div class="table-actions">
                            <button class="btn-edit" @onclick="() => ShowEditChoiceModal(choice)">Edit</button>
                            <button class="btn-delete" @onclick="() => ShowDeleteChoiceConfirm(choice)">Delete</button>
                        </div>
                    </div>
                }
            }
            else
            {
                <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                    No choices defined for this event.
                </p>
            }

            <div class="modal-actions">
                <button class="btn-secondary" @onclick="CloseChoicesModal">Close</button>
            </div>
        </div>
    </div>
}

@* Choice Edit Modal *@
@if (showChoiceModal)
{
    <div class="modal-overlay" @onclick="CloseChoiceModal">
        <div class="modal-content admin-modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;" @onclick:stopPropagation>
            <h2>@(editingChoice == null ? "Add Choice" : "Edit Choice")</h2>

            <div class="form-group">
                <label>Choice Text</label>
                <input class="form-input" @bind="choiceText" placeholder="What the player sees..." />
            </div>

            <div class="form-group">
                <label>Result Description (on success)</label>
                <textarea @bind="choiceResultDescription" placeholder="What happens when the choice succeeds..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Check Stat (Optional)</label>
                    <select @bind="choiceCheckStat">
                        <option value="">No Check</option>
                        @foreach (var stat in Enum.GetValues<StatType>())
                        {
                            <option value="@stat">@stat</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Check Difficulty (1-100)</label>
                    <input class="form-input" type="number" @bind="choiceCheckDifficulty" min="0" max="100" />
                </div>
            </div>

            <div class="form-group">
                <label>Stat Requirements (JSON)</label>
                <input class="form-input" @bind="choiceStatRequirements" placeholder='{"Intelligence": 20}' />
            </div>

            <h4 style="margin: 1rem 0 0.5rem; color: var(--success);">Success Rewards</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>STR</label>
                    <input class="form-input" type="number" @bind="choiceStrengthChange" />
                </div>
                <div class="form-group">
                    <label>AGI</label>
                    <input class="form-input" type="number" @bind="choiceAgilityChange" />
                </div>
                <div class="form-group">
                    <label>INT</label>
                    <input class="form-input" type="number" @bind="choiceIntelligenceChange" />
                </div>
                <div class="form-group">
                    <label>END</label>
                    <input class="form-input" type="number" @bind="choiceEnduranceChange" />
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>CHA</label>
                    <input class="form-input" type="number" @bind="choiceCharismaChange" />
                </div>
                <div class="form-group">
                    <label>LCK</label>
                    <input class="form-input" type="number" @bind="choiceLuckChange" />
                </div>
                <div class="form-group">
                    <label>Energy</label>
                    <input class="form-input" type="number" @bind="choiceEnergyChange" />
                </div>
                <div class="form-group">
                    <label>Health</label>
                    <input class="form-input" type="number" @bind="choiceHealthChange" />
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Gold</label>
                    <input class="form-input" type="number" @bind="choiceGoldChange" />
                </div>
                <div class="form-group">
                    <label>Reputation</label>
                    <input class="form-input" type="number" @bind="choiceReputationChange" />
                </div>
                <div class="form-group">
                    <label>Experience</label>
                    <input class="form-input" type="number" @bind="choiceExperienceChange" />
                </div>
                <div class="form-group">
                    <label>Grant Skill</label>
                    <select @bind="choiceGrantSkillId">
                        <option value="">None</option>
                        @foreach (var skill in skillLookup)
                        {
                            <option value="@skill.Id">@skill.Name</option>
                        }
                    </select>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(choiceCheckStat))
            {
                <h4 style="margin: 1rem 0 0.5rem; color: var(--danger);">Failure Penalties</h4>
                <div class="form-group">
                    <label>Failure Description</label>
                    <textarea @bind="choiceFailureDescription" placeholder="What happens on failure..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>STR</label>
                        <input class="form-input" type="number" @bind="choiceFailureStrengthChange" />
                    </div>
                    <div class="form-group">
                        <label>AGI</label>
                        <input class="form-input" type="number" @bind="choiceFailureAgilityChange" />
                    </div>
                    <div class="form-group">
                        <label>INT</label>
                        <input class="form-input" type="number" @bind="choiceFailureIntelligenceChange" />
                    </div>
                    <div class="form-group">
                        <label>END</label>
                        <input class="form-input" type="number" @bind="choiceFailureEnduranceChange" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Energy</label>
                        <input class="form-input" type="number" @bind="choiceFailureEnergyChange" />
                    </div>
                    <div class="form-group">
                        <label>Health</label>
                        <input class="form-input" type="number" @bind="choiceFailureHealthChange" />
                    </div>
                    <div class="form-group">
                        <label>Gold</label>
                        <input class="form-input" type="number" @bind="choiceFailureGoldChange" />
                    </div>
                    <div class="form-group">
                        <label>Reputation</label>
                        <input class="form-input" type="number" @bind="choiceFailureReputationChange" />
                    </div>
                </div>
            }

            <h4 style="margin: 1rem 0 0.5rem;">Advanced</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>Display Order</label>
                    <input class="form-input" type="number" @bind="choiceDisplayOrder" />
                </div>
                <div class="form-group">
                    <label>Trigger Battle (Enemy ID)</label>
                    <input class="form-input" type="number" @bind="choiceTriggerBattleId" />
                </div>
            </div>

            @if (!string.IsNullOrEmpty(choiceErrorMessage))
            {
                <div class="error-message">@choiceErrorMessage</div>
            }

            <div class="modal-actions">
                <button class="btn-secondary" @onclick="CloseChoiceModal">Cancel</button>
                <button class="btn-primary" @onclick="SaveChoice" disabled="@isSavingChoice">
                    @(isSavingChoice ? "Saving..." : "Save Choice")
                </button>
            </div>
        </div>
    </div>
}

@* Delete Storybook Confirm *@
@if (showDeleteConfirm)
{
    <div class="modal-overlay" @onclick="CloseDeleteConfirm">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="confirm-dialog">
                <h2>Delete Storybook</h2>
                <p>Are you sure you want to delete "@deletingStorybook?.Name"? This will also remove all associated events. This action cannot be undone.</p>
                <div class="confirm-actions">
                    <button class="btn-cancel" @onclick="CloseDeleteConfirm">Cancel</button>
                    <button class="btn-confirm-delete" @onclick="DeleteStorybook">Delete</button>
                </div>
            </div>
        </div>
    </div>
}

@* Delete Event Confirm *@
@if (showDeleteEventConfirm)
{
    <div class="modal-overlay" @onclick="CloseDeleteEventConfirm">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="confirm-dialog">
                <h2>Delete Event</h2>
                <p>Are you sure you want to delete "@deletingEvent?.Title"? This will also delete all choices. This action cannot be undone.</p>
                <div class="confirm-actions">
                    <button class="btn-cancel" @onclick="CloseDeleteEventConfirm">Cancel</button>
                    <button class="btn-confirm-delete" @onclick="DeleteEvent">Delete</button>
                </div>
            </div>
        </div>
    </div>
}

@* Delete Choice Confirm *@
@if (showDeleteChoiceConfirm)
{
    <div class="modal-overlay" @onclick="CloseDeleteChoiceConfirm">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="confirm-dialog">
                <h2>Delete Choice</h2>
                <p>Are you sure you want to delete this choice?</p>
                <div class="confirm-actions">
                    <button class="btn-cancel" @onclick="CloseDeleteChoiceConfirm">Cancel</button>
                    <button class="btn-confirm-delete" @onclick="DeleteChoice">Delete</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // Storybook state
    private List<AdminStorybookDto> storybooks = new();
    private bool isLoading = true;
    private bool showModal = false;
    private bool showDeleteConfirm = false;
    private bool isSaving = false;
    private string errorMessage = "";
    private AdminStorybookDto? editingStorybook;
    private AdminStorybookDto? deletingStorybook;

    // Storybook form fields
    private string formName = "";
    private string formDescription = "";
    private string formIconUrl = "";
    private string formTheme = "";
    private int formStrengthBonus = 0;
    private int formAgilityBonus = 0;
    private int formIntelligenceBonus = 0;
    private int formEnduranceBonus = 0;
    private int formCharismaBonus = 0;
    private int formLuckBonus = 0;
    private double formEventTriggerChance = 0.15;
    private bool formIsUnlockable = true;
    private string formUnlockCondition = "";

    // Events state
    private bool showEventsModal = false;
    private bool isLoadingEvents = false;
    private AdminStorybookDto? selectedStorybook;
    private List<AdminRandomEventDto> storybookEvents = new();

    // Event edit state
    private bool showEventModal = false;
    private bool showDeleteEventConfirm = false;
    private bool isSavingEvent = false;
    private string eventErrorMessage = "";
    private AdminRandomEventDto? editingEvent;
    private AdminRandomEventDto? deletingEvent;

    // Event form fields
    private string eventFormTitle = "";
    private string eventFormDescription = "";
    private string eventFormImageUrl = "";
    private Rarity eventFormRarity = Rarity.Common;
    private EventOutcome eventFormOutcomeType = EventOutcome.Neutral;
    private string eventFormTriggerActions = "Train,Explore";
    private string eventFormTriggerSeasons = "";
    private double eventFormBaseProbability = 0.1;
    private string eventFormStatRequirements = "";
    private bool eventFormIsActive = true;

    // Choices state
    private bool showChoicesModal = false;
    private AdminRandomEventDto? selectedEvent;
    private List<LookupDto> skillLookup = new();

    // Choice edit state
    private bool showChoiceModal = false;
    private bool showDeleteChoiceConfirm = false;
    private bool isSavingChoice = false;
    private string choiceErrorMessage = "";
    private AdminEventChoiceDto? editingChoice;
    private AdminEventChoiceDto? deletingChoice;

    // Choice form fields
    private string choiceText = "";
    private string choiceResultDescription = "";
    private string choiceStatRequirements = "";
    private string choiceCheckStat = "";
    private int choiceCheckDifficulty = 0;
    private int choiceStrengthChange = 0;
    private int choiceAgilityChange = 0;
    private int choiceIntelligenceChange = 0;
    private int choiceEnduranceChange = 0;
    private int choiceCharismaChange = 0;
    private int choiceLuckChange = 0;
    private int choiceEnergyChange = 0;
    private int choiceHealthChange = 0;
    private int choiceGoldChange = 0;
    private int choiceReputationChange = 0;
    private int choiceExperienceChange = 0;
    private string choiceFailureDescription = "";
    private int choiceFailureStrengthChange = 0;
    private int choiceFailureAgilityChange = 0;
    private int choiceFailureIntelligenceChange = 0;
    private int choiceFailureEnduranceChange = 0;
    private int choiceFailureCharismaChange = 0;
    private int choiceFailureLuckChange = 0;
    private int choiceFailureEnergyChange = 0;
    private int choiceFailureHealthChange = 0;
    private int choiceFailureGoldChange = 0;
    private int choiceFailureReputationChange = 0;
    private int? choiceTriggerBattleId = null;
    private string choiceGrantSkillId = "";
    private int choiceDisplayOrder = 0;

    protected override async Task OnInitializedAsync()
    {
        var loadStorybooksTask = LoadStorybooks();
        var loadSkillsTask = AdminApi.GetSkillLookupAsync();

        await Task.WhenAll(loadStorybooksTask, loadSkillsTask);
        skillLookup = await loadSkillsTask;
    }

    private async Task LoadStorybooks()
    {
        isLoading = true;
        storybooks = await AdminApi.GetAllStorybooksAsync();
        isLoading = false;
    }

    // ========== Storybook CRUD ==========

    private void ShowCreateModal()
    {
        editingStorybook = null;
        ResetStorybookForm();
        showModal = true;
    }

    private void ShowEditModal(AdminStorybookDto book)
    {
        editingStorybook = book;
        formName = book.Name;
        formDescription = book.Description;
        formIconUrl = book.IconUrl;
        formTheme = book.Theme;
        formStrengthBonus = book.StrengthBonus;
        formAgilityBonus = book.AgilityBonus;
        formIntelligenceBonus = book.IntelligenceBonus;
        formEnduranceBonus = book.EnduranceBonus;
        formCharismaBonus = book.CharismaBonus;
        formLuckBonus = book.LuckBonus;
        formEventTriggerChance = book.EventTriggerChance;
        formIsUnlockable = book.IsUnlockable;
        formUnlockCondition = book.UnlockCondition ?? "";
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        errorMessage = "";
    }

    private void ResetStorybookForm()
    {
        formName = "";
        formDescription = "";
        formIconUrl = "";
        formTheme = "";
        formStrengthBonus = 0;
        formAgilityBonus = 0;
        formIntelligenceBonus = 0;
        formEnduranceBonus = 0;
        formCharismaBonus = 0;
        formLuckBonus = 0;
        formEventTriggerChance = 0.15;
        formIsUnlockable = true;
        formUnlockCondition = "";
    }

    private async Task SaveStorybook()
    {
        if (string.IsNullOrWhiteSpace(formName))
        {
            errorMessage = "Name is required.";
            return;
        }

        isSaving = true;
        errorMessage = "";

        if (editingStorybook == null)
        {
            var dto = new CreateStorybookDto(
                formName, formDescription, formIconUrl, formTheme,
                formStrengthBonus, formAgilityBonus, formIntelligenceBonus,
                formEnduranceBonus, formCharismaBonus, formLuckBonus,
                formEventTriggerChance, formIsUnlockable,
                string.IsNullOrEmpty(formUnlockCondition) ? null : formUnlockCondition
            );
            var result = await AdminApi.CreateStorybookAsync(dto);
            if (result == null) errorMessage = "Failed to create storybook.";
        }
        else
        {
            var dto = new UpdateStorybookDto(
                formName, formDescription, formIconUrl, formTheme,
                formStrengthBonus, formAgilityBonus, formIntelligenceBonus,
                formEnduranceBonus, formCharismaBonus, formLuckBonus,
                formEventTriggerChance, formIsUnlockable,
                string.IsNullOrEmpty(formUnlockCondition) ? null : formUnlockCondition
            );
            var result = await AdminApi.UpdateStorybookAsync(editingStorybook.Id, dto);
            if (result == null) errorMessage = "Failed to update storybook.";
        }

        isSaving = false;

        if (string.IsNullOrEmpty(errorMessage))
        {
            CloseModal();
            await LoadStorybooks();
        }
    }

    private void ShowDeleteConfirm(AdminStorybookDto book)
    {
        deletingStorybook = book;
        showDeleteConfirm = true;
    }

    private void CloseDeleteConfirm()
    {
        showDeleteConfirm = false;
        deletingStorybook = null;
    }

    private async Task DeleteStorybook()
    {
        if (deletingStorybook == null) return;

        var success = await AdminApi.DeleteStorybookAsync(deletingStorybook.Id);
        CloseDeleteConfirm();
        if (success)
        {
            await LoadStorybooks();
        }
    }

    // ========== Events Modal ==========

    private async Task ShowEventsModal(AdminStorybookDto book)
    {
        selectedStorybook = book;
        showEventsModal = true;
        await LoadStorybookEvents();
    }

    private void CloseEventsModal()
    {
        showEventsModal = false;
        selectedStorybook = null;
        storybookEvents.Clear();
    }

    private async Task LoadStorybookEvents()
    {
        if (selectedStorybook == null) return;

        isLoadingEvents = true;
        var allEvents = await AdminApi.GetAllRandomEventsAsync();
        storybookEvents = allEvents.Where(e => e.StorybookId == selectedStorybook.Id).ToList();
        isLoadingEvents = false;
    }

    // ========== Event CRUD ==========

    private void ShowCreateEventModal()
    {
        editingEvent = null;
        ResetEventForm();
        showEventModal = true;
    }

    private void ShowEditEventModal(AdminRandomEventDto evt)
    {
        editingEvent = evt;
        eventFormTitle = evt.Title;
        eventFormDescription = evt.Description;
        eventFormImageUrl = evt.ImageUrl;
        eventFormRarity = evt.Rarity;
        eventFormOutcomeType = evt.OutcomeType;
        eventFormTriggerActions = evt.TriggerActions;
        eventFormTriggerSeasons = evt.TriggerSeasons ?? "";
        eventFormBaseProbability = evt.BaseProbability;
        eventFormStatRequirements = evt.StatRequirements ?? "";
        eventFormIsActive = evt.IsActive;
        showEventModal = true;
    }

    private void CloseEventModal()
    {
        showEventModal = false;
        eventErrorMessage = "";
    }

    private void ResetEventForm()
    {
        eventFormTitle = "";
        eventFormDescription = "";
        eventFormImageUrl = "";
        eventFormRarity = Rarity.Common;
        eventFormOutcomeType = EventOutcome.Neutral;
        eventFormTriggerActions = "Train,Explore";
        eventFormTriggerSeasons = "";
        eventFormBaseProbability = 0.1;
        eventFormStatRequirements = "";
        eventFormIsActive = true;
    }

    private async Task SaveEvent()
    {
        if (string.IsNullOrWhiteSpace(eventFormTitle))
        {
            eventErrorMessage = "Title is required.";
            return;
        }

        if (selectedStorybook == null) return;

        isSavingEvent = true;
        eventErrorMessage = "";

        if (editingEvent == null)
        {
            var dto = new CreateRandomEventDto(
                eventFormTitle, eventFormDescription, eventFormImageUrl,
                selectedStorybook.Id,
                eventFormRarity, eventFormOutcomeType, eventFormTriggerActions,
                string.IsNullOrEmpty(eventFormTriggerSeasons) ? null : eventFormTriggerSeasons,
                eventFormBaseProbability,
                string.IsNullOrEmpty(eventFormStatRequirements) ? null : eventFormStatRequirements,
                eventFormIsActive
            );
            var result = await AdminApi.CreateRandomEventAsync(dto);
            if (result == null) eventErrorMessage = "Failed to create event.";
        }
        else
        {
            var dto = new UpdateRandomEventDto(
                eventFormTitle, eventFormDescription, eventFormImageUrl,
                selectedStorybook.Id,
                eventFormRarity, eventFormOutcomeType, eventFormTriggerActions,
                string.IsNullOrEmpty(eventFormTriggerSeasons) ? null : eventFormTriggerSeasons,
                eventFormBaseProbability,
                string.IsNullOrEmpty(eventFormStatRequirements) ? null : eventFormStatRequirements,
                eventFormIsActive
            );
            var result = await AdminApi.UpdateRandomEventAsync(editingEvent.Id, dto);
            if (result == null) eventErrorMessage = "Failed to update event.";
        }

        isSavingEvent = false;

        if (string.IsNullOrEmpty(eventErrorMessage))
        {
            CloseEventModal();
            await LoadStorybookEvents();
            await LoadStorybooks(); // Refresh event counts
        }
    }

    private void ShowDeleteEventConfirm(AdminRandomEventDto evt)
    {
        deletingEvent = evt;
        showDeleteEventConfirm = true;
    }

    private void CloseDeleteEventConfirm()
    {
        showDeleteEventConfirm = false;
        deletingEvent = null;
    }

    private async Task DeleteEvent()
    {
        if (deletingEvent == null) return;

        var success = await AdminApi.DeleteRandomEventAsync(deletingEvent.Id);
        CloseDeleteEventConfirm();
        if (success)
        {
            await LoadStorybookEvents();
            await LoadStorybooks(); // Refresh event counts
        }
    }

    // ========== Choices Modal ==========

    private async Task ShowChoicesModal(AdminRandomEventDto evt)
    {
        selectedEvent = await AdminApi.GetRandomEventAsync(evt.Id);
        showChoicesModal = true;
    }

    private void CloseChoicesModal()
    {
        showChoicesModal = false;
        selectedEvent = null;
    }

    // ========== Choice CRUD ==========

    private void ShowAddChoiceModal()
    {
        editingChoice = null;
        ResetChoiceForm();
        choiceDisplayOrder = (selectedEvent?.Choices?.Count ?? 0) + 1;
        showChoiceModal = true;
    }

    private void ShowEditChoiceModal(AdminEventChoiceDto choice)
    {
        editingChoice = choice;
        choiceText = choice.Text;
        choiceResultDescription = choice.ResultDescription;
        choiceStatRequirements = choice.StatRequirements ?? "";
        choiceCheckStat = choice.CheckStat?.ToString() ?? "";
        choiceCheckDifficulty = choice.CheckDifficulty;
        choiceStrengthChange = choice.StrengthChange;
        choiceAgilityChange = choice.AgilityChange;
        choiceIntelligenceChange = choice.IntelligenceChange;
        choiceEnduranceChange = choice.EnduranceChange;
        choiceCharismaChange = choice.CharismaChange;
        choiceLuckChange = choice.LuckChange;
        choiceEnergyChange = choice.EnergyChange;
        choiceHealthChange = choice.HealthChange;
        choiceGoldChange = choice.GoldChange;
        choiceReputationChange = choice.ReputationChange;
        choiceExperienceChange = choice.ExperienceChange;
        choiceFailureDescription = choice.FailureDescription ?? "";
        choiceFailureStrengthChange = choice.FailureStrengthChange;
        choiceFailureAgilityChange = choice.FailureAgilityChange;
        choiceFailureIntelligenceChange = choice.FailureIntelligenceChange;
        choiceFailureEnduranceChange = choice.FailureEnduranceChange;
        choiceFailureCharismaChange = choice.FailureCharismaChange;
        choiceFailureLuckChange = choice.FailureLuckChange;
        choiceFailureEnergyChange = choice.FailureEnergyChange;
        choiceFailureHealthChange = choice.FailureHealthChange;
        choiceFailureGoldChange = choice.FailureGoldChange;
        choiceFailureReputationChange = choice.FailureReputationChange;
        choiceTriggerBattleId = choice.TriggerBattleId;
        choiceGrantSkillId = choice.GrantSkillId?.ToString() ?? "";
        choiceDisplayOrder = choice.DisplayOrder;
        showChoiceModal = true;
    }

    private void CloseChoiceModal()
    {
        showChoiceModal = false;
        choiceErrorMessage = "";
    }

    private void ResetChoiceForm()
    {
        choiceText = "";
        choiceResultDescription = "";
        choiceStatRequirements = "";
        choiceCheckStat = "";
        choiceCheckDifficulty = 0;
        choiceStrengthChange = 0;
        choiceAgilityChange = 0;
        choiceIntelligenceChange = 0;
        choiceEnduranceChange = 0;
        choiceCharismaChange = 0;
        choiceLuckChange = 0;
        choiceEnergyChange = 0;
        choiceHealthChange = 0;
        choiceGoldChange = 0;
        choiceReputationChange = 0;
        choiceExperienceChange = 0;
        choiceFailureDescription = "";
        choiceFailureStrengthChange = 0;
        choiceFailureAgilityChange = 0;
        choiceFailureIntelligenceChange = 0;
        choiceFailureEnduranceChange = 0;
        choiceFailureCharismaChange = 0;
        choiceFailureLuckChange = 0;
        choiceFailureEnergyChange = 0;
        choiceFailureHealthChange = 0;
        choiceFailureGoldChange = 0;
        choiceFailureReputationChange = 0;
        choiceTriggerBattleId = null;
        choiceGrantSkillId = "";
        choiceDisplayOrder = 0;
    }

    private async Task SaveChoice()
    {
        if (string.IsNullOrWhiteSpace(choiceText))
        {
            choiceErrorMessage = "Choice text is required.";
            return;
        }

        if (selectedEvent == null) return;

        isSavingChoice = true;
        choiceErrorMessage = "";

        StatType? checkStat = string.IsNullOrEmpty(choiceCheckStat) ? null : Enum.Parse<StatType>(choiceCheckStat);
        int? grantSkillId = string.IsNullOrEmpty(choiceGrantSkillId) ? null : int.Parse(choiceGrantSkillId);

        if (editingChoice == null)
        {
            var dto = new CreateEventChoiceDto(
                selectedEvent.Id, choiceText, choiceResultDescription,
                string.IsNullOrEmpty(choiceStatRequirements) ? null : choiceStatRequirements,
                checkStat, choiceCheckDifficulty,
                choiceStrengthChange, choiceAgilityChange, choiceIntelligenceChange,
                choiceEnduranceChange, choiceCharismaChange, choiceLuckChange,
                choiceEnergyChange, choiceHealthChange, choiceGoldChange,
                choiceReputationChange, choiceExperienceChange,
                string.IsNullOrEmpty(choiceFailureDescription) ? null : choiceFailureDescription,
                choiceFailureStrengthChange, choiceFailureAgilityChange, choiceFailureIntelligenceChange,
                choiceFailureEnduranceChange, choiceFailureCharismaChange, choiceFailureLuckChange,
                choiceFailureEnergyChange, choiceFailureHealthChange, choiceFailureGoldChange,
                choiceFailureReputationChange,
                null, choiceTriggerBattleId == 0 ? null : choiceTriggerBattleId,
                grantSkillId, null, choiceDisplayOrder
            );
            var result = await AdminApi.CreateEventChoiceAsync(dto);
            if (result == null) choiceErrorMessage = "Failed to create choice.";
        }
        else
        {
            var dto = new UpdateEventChoiceDto(
                choiceText, choiceResultDescription,
                string.IsNullOrEmpty(choiceStatRequirements) ? null : choiceStatRequirements,
                checkStat, choiceCheckDifficulty,
                choiceStrengthChange, choiceAgilityChange, choiceIntelligenceChange,
                choiceEnduranceChange, choiceCharismaChange, choiceLuckChange,
                choiceEnergyChange, choiceHealthChange, choiceGoldChange,
                choiceReputationChange, choiceExperienceChange,
                string.IsNullOrEmpty(choiceFailureDescription) ? null : choiceFailureDescription,
                choiceFailureStrengthChange, choiceFailureAgilityChange, choiceFailureIntelligenceChange,
                choiceFailureEnduranceChange, choiceFailureCharismaChange, choiceFailureLuckChange,
                choiceFailureEnergyChange, choiceFailureHealthChange, choiceFailureGoldChange,
                choiceFailureReputationChange,
                null, choiceTriggerBattleId == 0 ? null : choiceTriggerBattleId,
                grantSkillId, null, choiceDisplayOrder
            );
            var result = await AdminApi.UpdateEventChoiceAsync(editingChoice.Id, dto);
            if (result == null) choiceErrorMessage = "Failed to update choice.";
        }

        isSavingChoice = false;

        if (string.IsNullOrEmpty(choiceErrorMessage))
        {
            CloseChoiceModal();
            selectedEvent = await AdminApi.GetRandomEventAsync(selectedEvent.Id);
        }
    }

    private void ShowDeleteChoiceConfirm(AdminEventChoiceDto choice)
    {
        deletingChoice = choice;
        showDeleteChoiceConfirm = true;
    }

    private void CloseDeleteChoiceConfirm()
    {
        showDeleteChoiceConfirm = false;
        deletingChoice = null;
    }

    private async Task DeleteChoice()
    {
        if (deletingChoice == null || selectedEvent == null) return;

        var success = await AdminApi.DeleteEventChoiceAsync(deletingChoice.Id);
        CloseDeleteChoiceConfirm();
        if (success)
        {
            selectedEvent = await AdminApi.GetRandomEventAsync(selectedEvent.Id);
        }
    }
}
