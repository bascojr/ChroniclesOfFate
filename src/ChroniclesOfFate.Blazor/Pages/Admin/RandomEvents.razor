@page "/admin/events"
@layout ChroniclesOfFate.Blazor.Shared.AdminLayout
@attribute [Authorize(Roles = "Admin")]
@inject IAdminApiService AdminApi
@using ChroniclesOfFate.Core.Enums

<PageTitle>Random Events - Admin</PageTitle>

<div class="admin-table-container">
    <div class="admin-table-header">
        <h2>Random Events</h2>
        <button class="btn-create" @onclick="ShowCreateModal">+ New Event</button>
    </div>

    @if (isLoading)
    {
        <div class="admin-loading">Loading events...</div>
    }
    else
    {
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Storybook</th>
                    <th>Rarity</th>
                    <th>Outcome</th>
                    <th>Choices</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var evt in events)
                {
                    <tr>
                        <td>@evt.Title</td>
                        <td>@(evt.StorybookName ?? "Global")</td>
                        <td>
                            <span class="badge badge-@evt.Rarity.ToString().ToLower()">@evt.Rarity</span>
                        </td>
                        <td>@evt.OutcomeType</td>
                        <td>@evt.ChoiceCount</td>
                        <td>
                            <span class="badge @(evt.IsActive ? "badge-active" : "badge-inactive")">
                                @(evt.IsActive ? "Active" : "Inactive")
                            </span>
                        </td>
                        <td>
                            <div class="table-actions">
                                <button class="btn-view" @onclick="() => ShowChoicesModal(evt)">Choices</button>
                                <button class="btn-edit" @onclick="() => ShowEditModal(evt)">Edit</button>
                                <button class="btn-delete" @onclick="() => ShowDeleteConfirm(evt)">Delete</button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@* Event Edit Modal *@
@if (showModal)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content admin-modal" @onclick:stopPropagation>
            <h2>@(editingEvent == null ? "Create Random Event" : "Edit Random Event")</h2>

            <div class="form-row">
                <div class="form-group">
                    <label>Title</label>
                    <input class="form-input" @bind="formTitle" placeholder="Event title" />
                </div>
                <div class="form-group">
                    <label>Storybook (Optional)</label>
                    <select @bind="formStorybookId">
                        <option value="">Global Event</option>
                        @foreach (var book in storybookLookup)
                        {
                            <option value="@book.Id">@book.Name</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea @bind="formDescription" placeholder="Event description..."></textarea>
            </div>

            <div class="form-group">
                <label>Image URL</label>
                <input class="form-input" @bind="formImageUrl" placeholder="https://..." />
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Rarity</label>
                    <select @bind="formRarity">
                        @foreach (var rarity in Enum.GetValues<Rarity>())
                        {
                            <option value="@rarity">@rarity</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Outcome Type</label>
                    <select @bind="formOutcomeType">
                        @foreach (var outcome in Enum.GetValues<EventOutcome>())
                        {
                            <option value="@outcome">@outcome</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Trigger Actions (comma-separated)</label>
                    <input class="form-input" @bind="formTriggerActions" placeholder="Train,Explore,Battle" />
                </div>
                <div class="form-group">
                    <label>Base Probability (0.0-1.0)</label>
                    <input class="form-input" type="number" step="0.01" @bind="formBaseProbability" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Trigger Seasons (Optional)</label>
                    <input class="form-input" @bind="formTriggerSeasons" placeholder="Spring,Summer" />
                </div>
                <div class="form-group">
                    <label>Stat Requirements (JSON)</label>
                    <input class="form-input" @bind="formStatRequirements" placeholder='{"Strength": 30}' />
                </div>
            </div>

            <div class="form-group form-checkbox">
                <input type="checkbox" @bind="formIsActive" id="isActive" />
                <label for="isActive">Active</label>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">@errorMessage</div>
            }

            <div class="modal-actions">
                <button class="btn-secondary" @onclick="CloseModal">Cancel</button>
                <button class="btn-primary" @onclick="SaveEvent" disabled="@isSaving">
                    @(isSaving ? "Saving..." : "Save")
                </button>
            </div>
        </div>
    </div>
}

@* Choices Management Modal *@
@if (showChoicesModal)
{
    <div class="modal-overlay" @onclick="CloseChoicesModal">
        <div class="modal-content admin-modal" style="max-width: 900px;" @onclick:stopPropagation>
            <h2>Manage Choices: @selectedEvent?.Title</h2>

            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                <button class="btn-create" @onclick="ShowAddChoiceModal">+ Add Choice</button>
            </div>

            @if (selectedEvent?.Choices?.Any() == true)
            {
                @foreach (var choice in selectedEvent.Choices.OrderBy(c => c.DisplayOrder))
                {
                    <div class="choice-item">
                        <span class="choice-order">#@choice.DisplayOrder</span>
                        <span class="choice-text">@choice.Text</span>
                        <div class="table-actions">
                            <button class="btn-edit" @onclick="() => ShowEditChoiceModal(choice)">Edit</button>
                            <button class="btn-delete" @onclick="() => ShowDeleteChoiceConfirm(choice)">Delete</button>
                        </div>
                    </div>
                }
            }
            else
            {
                <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                    No choices defined for this event.
                </p>
            }

            <div class="modal-actions">
                <button class="btn-secondary" @onclick="CloseChoicesModal">Close</button>
            </div>
        </div>
    </div>
}

@* Choice Edit Modal *@
@if (showChoiceModal)
{
    <div class="modal-overlay" @onclick="CloseChoiceModal">
        <div class="modal-content admin-modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;" @onclick:stopPropagation>
            <h2>@(editingChoice == null ? "Add Choice" : "Edit Choice")</h2>

            <div class="form-row">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Choice Text</label>
                    <input class="form-input" @bind="choiceText" placeholder="What the player sees..." />
                </div>
            </div>

            <div class="form-group">
                <label>Result Description (on success)</label>
                <textarea @bind="choiceResultDescription" placeholder="What happens when the choice succeeds..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Check Stat (Optional)</label>
                    <select @bind="choiceCheckStat">
                        <option value="">No Check</option>
                        @foreach (var stat in Enum.GetValues<StatType>())
                        {
                            <option value="@stat">@stat</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Check Difficulty (1-100)</label>
                    <input class="form-input" type="number" @bind="choiceCheckDifficulty" min="0" max="100" />
                </div>
            </div>

            <div class="form-group">
                <label>Stat Requirements (JSON)</label>
                <input class="form-input" @bind="choiceStatRequirements" placeholder='{"Intelligence": 20}' />
            </div>

            <h4 style="margin: 1rem 0 0.5rem; color: var(--success);">Success Rewards</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>STR Change</label>
                    <input class="form-input" type="number" @bind="choiceStrengthChange" />
                </div>
                <div class="form-group">
                    <label>AGI Change</label>
                    <input class="form-input" type="number" @bind="choiceAgilityChange" />
                </div>
                <div class="form-group">
                    <label>INT Change</label>
                    <input class="form-input" type="number" @bind="choiceIntelligenceChange" />
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>END Change</label>
                    <input class="form-input" type="number" @bind="choiceEnduranceChange" />
                </div>
                <div class="form-group">
                    <label>CHA Change</label>
                    <input class="form-input" type="number" @bind="choiceCharismaChange" />
                </div>
                <div class="form-group">
                    <label>LCK Change</label>
                    <input class="form-input" type="number" @bind="choiceLuckChange" />
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Energy</label>
                    <input class="form-input" type="number" @bind="choiceEnergyChange" />
                </div>
                <div class="form-group">
                    <label>Health</label>
                    <input class="form-input" type="number" @bind="choiceHealthChange" />
                </div>
                <div class="form-group">
                    <label>Gold</label>
                    <input class="form-input" type="number" @bind="choiceGoldChange" />
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Reputation</label>
                    <input class="form-input" type="number" @bind="choiceReputationChange" />
                </div>
                <div class="form-group">
                    <label>Experience</label>
                    <input class="form-input" type="number" @bind="choiceExperienceChange" />
                </div>
                <div class="form-group">
                    <label>Grant Skill</label>
                    <select @bind="choiceGrantSkillId">
                        <option value="">None</option>
                        @foreach (var skill in skillLookup)
                        {
                            <option value="@skill.Id">@skill.Name</option>
                        }
                    </select>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(choiceCheckStat))
            {
                <h4 style="margin: 1rem 0 0.5rem; color: var(--danger);">Failure Penalties</h4>
                <div class="form-group">
                    <label>Failure Description</label>
                    <textarea @bind="choiceFailureDescription" placeholder="What happens on failure..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>STR Change</label>
                        <input class="form-input" type="number" @bind="choiceFailureStrengthChange" />
                    </div>
                    <div class="form-group">
                        <label>AGI Change</label>
                        <input class="form-input" type="number" @bind="choiceFailureAgilityChange" />
                    </div>
                    <div class="form-group">
                        <label>INT Change</label>
                        <input class="form-input" type="number" @bind="choiceFailureIntelligenceChange" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Energy</label>
                        <input class="form-input" type="number" @bind="choiceFailureEnergyChange" />
                    </div>
                    <div class="form-group">
                        <label>Health</label>
                        <input class="form-input" type="number" @bind="choiceFailureHealthChange" />
                    </div>
                    <div class="form-group">
                        <label>Gold</label>
                        <input class="form-input" type="number" @bind="choiceFailureGoldChange" />
                    </div>
                </div>
            }

            <h4 style="margin: 1rem 0 0.5rem;">Advanced</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>Display Order</label>
                    <input class="form-input" type="number" @bind="choiceDisplayOrder" />
                </div>
                <div class="form-group">
                    <label>Trigger Battle (Enemy ID)</label>
                    <input class="form-input" type="number" @bind="choiceTriggerBattleId" />
                </div>
            </div>

            @if (!string.IsNullOrEmpty(choiceErrorMessage))
            {
                <div class="error-message">@choiceErrorMessage</div>
            }

            <div class="modal-actions">
                <button class="btn-secondary" @onclick="CloseChoiceModal">Cancel</button>
                <button class="btn-primary" @onclick="SaveChoice" disabled="@isSavingChoice">
                    @(isSavingChoice ? "Saving..." : "Save Choice")
                </button>
            </div>
        </div>
    </div>
}

@* Delete Event Confirm *@
@if (showDeleteConfirm)
{
    <div class="modal-overlay" @onclick="CloseDeleteConfirm">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="confirm-dialog">
                <h2>Delete Event</h2>
                <p>Are you sure you want to delete "@deletingEvent?.Title"? This will also delete all choices. This action cannot be undone.</p>
                <div class="confirm-actions">
                    <button class="btn-cancel" @onclick="CloseDeleteConfirm">Cancel</button>
                    <button class="btn-confirm-delete" @onclick="DeleteEvent">Delete</button>
                </div>
            </div>
        </div>
    </div>
}

@* Delete Choice Confirm *@
@if (showDeleteChoiceConfirm)
{
    <div class="modal-overlay" @onclick="CloseDeleteChoiceConfirm">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="confirm-dialog">
                <h2>Delete Choice</h2>
                <p>Are you sure you want to delete this choice?</p>
                <div class="confirm-actions">
                    <button class="btn-cancel" @onclick="CloseDeleteChoiceConfirm">Cancel</button>
                    <button class="btn-confirm-delete" @onclick="DeleteChoice">Delete</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<AdminRandomEventDto> events = new();
    private List<LookupDto> storybookLookup = new();
    private List<LookupDto> skillLookup = new();
    private bool isLoading = true;
    private bool showModal = false;
    private bool showChoicesModal = false;
    private bool showChoiceModal = false;
    private bool showDeleteConfirm = false;
    private bool showDeleteChoiceConfirm = false;
    private bool isSaving = false;
    private bool isSavingChoice = false;
    private string errorMessage = "";
    private string choiceErrorMessage = "";

    private AdminRandomEventDto? editingEvent;
    private AdminRandomEventDto? deletingEvent;
    private AdminRandomEventDto? selectedEvent;
    private AdminEventChoiceDto? editingChoice;
    private AdminEventChoiceDto? deletingChoice;

    // Event form fields
    private string formTitle = "";
    private string formDescription = "";
    private string formImageUrl = "";
    private string formStorybookId = "";
    private Rarity formRarity = Rarity.Common;
    private EventOutcome formOutcomeType = EventOutcome.Neutral;
    private string formTriggerActions = "Train,Explore";
    private string formTriggerSeasons = "";
    private double formBaseProbability = 0.1;
    private string formStatRequirements = "";
    private bool formIsActive = true;

    // Choice form fields
    private string choiceText = "";
    private string choiceResultDescription = "";
    private string choiceStatRequirements = "";
    private string choiceCheckStat = "";
    private int choiceCheckDifficulty = 0;
    private int choiceStrengthChange = 0;
    private int choiceAgilityChange = 0;
    private int choiceIntelligenceChange = 0;
    private int choiceEnduranceChange = 0;
    private int choiceCharismaChange = 0;
    private int choiceLuckChange = 0;
    private int choiceEnergyChange = 0;
    private int choiceHealthChange = 0;
    private int choiceGoldChange = 0;
    private int choiceReputationChange = 0;
    private int choiceExperienceChange = 0;
    private string choiceFailureDescription = "";
    private int choiceFailureStrengthChange = 0;
    private int choiceFailureAgilityChange = 0;
    private int choiceFailureIntelligenceChange = 0;
    private int choiceFailureEnduranceChange = 0;
    private int choiceFailureCharismaChange = 0;
    private int choiceFailureLuckChange = 0;
    private int choiceFailureEnergyChange = 0;
    private int choiceFailureHealthChange = 0;
    private int choiceFailureGoldChange = 0;
    private int choiceFailureReputationChange = 0;
    private int? choiceFollowUpEventId = null;
    private int? choiceTriggerBattleId = null;
    private string choiceGrantSkillId = "";
    private string choiceFailureGrantSkillId = "";
    private int choiceDisplayOrder = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        var eventsTask = AdminApi.GetAllRandomEventsAsync();
        var storybooksTask = AdminApi.GetStorybookLookupAsync();
        var skillsTask = AdminApi.GetSkillLookupAsync();

        await Task.WhenAll(eventsTask, storybooksTask, skillsTask);

        events = await eventsTask;
        storybookLookup = await storybooksTask;
        skillLookup = await skillsTask;
        isLoading = false;
    }

    private void ShowCreateModal()
    {
        editingEvent = null;
        ResetEventForm();
        showModal = true;
    }

    private void ShowEditModal(AdminRandomEventDto evt)
    {
        editingEvent = evt;
        formTitle = evt.Title;
        formDescription = evt.Description;
        formImageUrl = evt.ImageUrl;
        formStorybookId = evt.StorybookId?.ToString() ?? "";
        formRarity = evt.Rarity;
        formOutcomeType = evt.OutcomeType;
        formTriggerActions = evt.TriggerActions;
        formTriggerSeasons = evt.TriggerSeasons ?? "";
        formBaseProbability = evt.BaseProbability;
        formStatRequirements = evt.StatRequirements ?? "";
        formIsActive = evt.IsActive;
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        errorMessage = "";
    }

    private void ResetEventForm()
    {
        formTitle = "";
        formDescription = "";
        formImageUrl = "";
        formStorybookId = "";
        formRarity = Rarity.Common;
        formOutcomeType = EventOutcome.Neutral;
        formTriggerActions = "Train,Explore";
        formTriggerSeasons = "";
        formBaseProbability = 0.1;
        formStatRequirements = "";
        formIsActive = true;
    }

    private async Task SaveEvent()
    {
        if (string.IsNullOrWhiteSpace(formTitle))
        {
            errorMessage = "Title is required.";
            return;
        }

        isSaving = true;
        errorMessage = "";

        int? storybookId = string.IsNullOrEmpty(formStorybookId) ? null : int.Parse(formStorybookId);

        if (editingEvent == null)
        {
            var dto = new CreateRandomEventDto(
                formTitle, formDescription, formImageUrl, storybookId,
                formRarity, formOutcomeType, formTriggerActions,
                string.IsNullOrEmpty(formTriggerSeasons) ? null : formTriggerSeasons,
                formBaseProbability,
                string.IsNullOrEmpty(formStatRequirements) ? null : formStatRequirements,
                formIsActive
            );
            var result = await AdminApi.CreateRandomEventAsync(dto);
            if (result == null) errorMessage = "Failed to create event.";
        }
        else
        {
            var dto = new UpdateRandomEventDto(
                formTitle, formDescription, formImageUrl, storybookId,
                formRarity, formOutcomeType, formTriggerActions,
                string.IsNullOrEmpty(formTriggerSeasons) ? null : formTriggerSeasons,
                formBaseProbability,
                string.IsNullOrEmpty(formStatRequirements) ? null : formStatRequirements,
                formIsActive
            );
            var result = await AdminApi.UpdateRandomEventAsync(editingEvent.Id, dto);
            if (result == null) errorMessage = "Failed to update event.";
        }

        isSaving = false;

        if (string.IsNullOrEmpty(errorMessage))
        {
            CloseModal();
            await LoadData();
        }
    }

    private void ShowDeleteConfirm(AdminRandomEventDto evt)
    {
        deletingEvent = evt;
        showDeleteConfirm = true;
    }

    private void CloseDeleteConfirm()
    {
        showDeleteConfirm = false;
        deletingEvent = null;
    }

    private async Task DeleteEvent()
    {
        if (deletingEvent == null) return;

        var success = await AdminApi.DeleteRandomEventAsync(deletingEvent.Id);
        CloseDeleteConfirm();
        if (success)
        {
            await LoadData();
        }
    }

    // Choice Management
    private async Task ShowChoicesModal(AdminRandomEventDto evt)
    {
        selectedEvent = await AdminApi.GetRandomEventAsync(evt.Id);
        showChoicesModal = true;
    }

    private void CloseChoicesModal()
    {
        showChoicesModal = false;
        selectedEvent = null;
    }

    private void ShowAddChoiceModal()
    {
        editingChoice = null;
        ResetChoiceForm();
        choiceDisplayOrder = (selectedEvent?.Choices?.Count ?? 0) + 1;
        showChoiceModal = true;
    }

    private void ShowEditChoiceModal(AdminEventChoiceDto choice)
    {
        editingChoice = choice;
        choiceText = choice.Text;
        choiceResultDescription = choice.ResultDescription;
        choiceStatRequirements = choice.StatRequirements ?? "";
        choiceCheckStat = choice.CheckStat?.ToString() ?? "";
        choiceCheckDifficulty = choice.CheckDifficulty;
        choiceStrengthChange = choice.StrengthChange;
        choiceAgilityChange = choice.AgilityChange;
        choiceIntelligenceChange = choice.IntelligenceChange;
        choiceEnduranceChange = choice.EnduranceChange;
        choiceCharismaChange = choice.CharismaChange;
        choiceLuckChange = choice.LuckChange;
        choiceEnergyChange = choice.EnergyChange;
        choiceHealthChange = choice.HealthChange;
        choiceGoldChange = choice.GoldChange;
        choiceReputationChange = choice.ReputationChange;
        choiceExperienceChange = choice.ExperienceChange;
        choiceFailureDescription = choice.FailureDescription ?? "";
        choiceFailureStrengthChange = choice.FailureStrengthChange;
        choiceFailureAgilityChange = choice.FailureAgilityChange;
        choiceFailureIntelligenceChange = choice.FailureIntelligenceChange;
        choiceFailureEnduranceChange = choice.FailureEnduranceChange;
        choiceFailureCharismaChange = choice.FailureCharismaChange;
        choiceFailureLuckChange = choice.FailureLuckChange;
        choiceFailureEnergyChange = choice.FailureEnergyChange;
        choiceFailureHealthChange = choice.FailureHealthChange;
        choiceFailureGoldChange = choice.FailureGoldChange;
        choiceFailureReputationChange = choice.FailureReputationChange;
        choiceFollowUpEventId = choice.FollowUpEventId;
        choiceTriggerBattleId = choice.TriggerBattleId;
        choiceGrantSkillId = choice.GrantSkillId?.ToString() ?? "";
        choiceFailureGrantSkillId = choice.FailureGrantSkillId?.ToString() ?? "";
        choiceDisplayOrder = choice.DisplayOrder;
        showChoiceModal = true;
    }

    private void CloseChoiceModal()
    {
        showChoiceModal = false;
        choiceErrorMessage = "";
    }

    private void ResetChoiceForm()
    {
        choiceText = "";
        choiceResultDescription = "";
        choiceStatRequirements = "";
        choiceCheckStat = "";
        choiceCheckDifficulty = 0;
        choiceStrengthChange = 0;
        choiceAgilityChange = 0;
        choiceIntelligenceChange = 0;
        choiceEnduranceChange = 0;
        choiceCharismaChange = 0;
        choiceLuckChange = 0;
        choiceEnergyChange = 0;
        choiceHealthChange = 0;
        choiceGoldChange = 0;
        choiceReputationChange = 0;
        choiceExperienceChange = 0;
        choiceFailureDescription = "";
        choiceFailureStrengthChange = 0;
        choiceFailureAgilityChange = 0;
        choiceFailureIntelligenceChange = 0;
        choiceFailureEnduranceChange = 0;
        choiceFailureCharismaChange = 0;
        choiceFailureLuckChange = 0;
        choiceFailureEnergyChange = 0;
        choiceFailureHealthChange = 0;
        choiceFailureGoldChange = 0;
        choiceFailureReputationChange = 0;
        choiceFollowUpEventId = null;
        choiceTriggerBattleId = null;
        choiceGrantSkillId = "";
        choiceFailureGrantSkillId = "";
        choiceDisplayOrder = 0;
    }

    private async Task SaveChoice()
    {
        if (string.IsNullOrWhiteSpace(choiceText))
        {
            choiceErrorMessage = "Choice text is required.";
            return;
        }

        if (selectedEvent == null) return;

        isSavingChoice = true;
        choiceErrorMessage = "";

        StatType? checkStat = string.IsNullOrEmpty(choiceCheckStat) ? null : Enum.Parse<StatType>(choiceCheckStat);
        int? grantSkillId = string.IsNullOrEmpty(choiceGrantSkillId) ? null : int.Parse(choiceGrantSkillId);
        int? failureGrantSkillId = string.IsNullOrEmpty(choiceFailureGrantSkillId) ? null : int.Parse(choiceFailureGrantSkillId);

        if (editingChoice == null)
        {
            var dto = new CreateEventChoiceDto(
                selectedEvent.Id, choiceText, choiceResultDescription,
                string.IsNullOrEmpty(choiceStatRequirements) ? null : choiceStatRequirements,
                checkStat, choiceCheckDifficulty,
                choiceStrengthChange, choiceAgilityChange, choiceIntelligenceChange,
                choiceEnduranceChange, choiceCharismaChange, choiceLuckChange,
                choiceEnergyChange, choiceHealthChange, choiceGoldChange,
                choiceReputationChange, choiceExperienceChange,
                string.IsNullOrEmpty(choiceFailureDescription) ? null : choiceFailureDescription,
                choiceFailureStrengthChange, choiceFailureAgilityChange, choiceFailureIntelligenceChange,
                choiceFailureEnduranceChange, choiceFailureCharismaChange, choiceFailureLuckChange,
                choiceFailureEnergyChange, choiceFailureHealthChange, choiceFailureGoldChange,
                choiceFailureReputationChange,
                choiceFollowUpEventId, choiceTriggerBattleId == 0 ? null : choiceTriggerBattleId,
                grantSkillId, failureGrantSkillId, choiceDisplayOrder
            );
            var result = await AdminApi.CreateEventChoiceAsync(dto);
            if (result == null) choiceErrorMessage = "Failed to create choice.";
        }
        else
        {
            var dto = new UpdateEventChoiceDto(
                choiceText, choiceResultDescription,
                string.IsNullOrEmpty(choiceStatRequirements) ? null : choiceStatRequirements,
                checkStat, choiceCheckDifficulty,
                choiceStrengthChange, choiceAgilityChange, choiceIntelligenceChange,
                choiceEnduranceChange, choiceCharismaChange, choiceLuckChange,
                choiceEnergyChange, choiceHealthChange, choiceGoldChange,
                choiceReputationChange, choiceExperienceChange,
                string.IsNullOrEmpty(choiceFailureDescription) ? null : choiceFailureDescription,
                choiceFailureStrengthChange, choiceFailureAgilityChange, choiceFailureIntelligenceChange,
                choiceFailureEnduranceChange, choiceFailureCharismaChange, choiceFailureLuckChange,
                choiceFailureEnergyChange, choiceFailureHealthChange, choiceFailureGoldChange,
                choiceFailureReputationChange,
                choiceFollowUpEventId, choiceTriggerBattleId == 0 ? null : choiceTriggerBattleId,
                grantSkillId, failureGrantSkillId, choiceDisplayOrder
            );
            var result = await AdminApi.UpdateEventChoiceAsync(editingChoice.Id, dto);
            if (result == null) choiceErrorMessage = "Failed to update choice.";
        }

        isSavingChoice = false;

        if (string.IsNullOrEmpty(choiceErrorMessage))
        {
            CloseChoiceModal();
            selectedEvent = await AdminApi.GetRandomEventAsync(selectedEvent.Id);
        }
    }

    private void ShowDeleteChoiceConfirm(AdminEventChoiceDto choice)
    {
        deletingChoice = choice;
        showDeleteChoiceConfirm = true;
    }

    private void CloseDeleteChoiceConfirm()
    {
        showDeleteChoiceConfirm = false;
        deletingChoice = null;
    }

    private async Task DeleteChoice()
    {
        if (deletingChoice == null || selectedEvent == null) return;

        var success = await AdminApi.DeleteEventChoiceAsync(deletingChoice.Id);
        CloseDeleteChoiceConfirm();
        if (success)
        {
            selectedEvent = await AdminApi.GetRandomEventAsync(selectedEvent.Id);
        }
    }
}
